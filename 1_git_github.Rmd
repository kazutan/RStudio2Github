---
title: "1. GitとGitHub"
author: "kazutan"
output: html_document
---

```{r child="children/chunk_options.Rmd"}
```


## Gitとは
Gitとはバージョン管理のためのツールです。Gitを利用することでバージョン管理が容易になりますし、さらに共同開発も効率的に行うことができます。

考え方などちょっと慣れないところがあるかも知れませんが、一度イメージができるとそこまで難しく感じなくなると思います。

### Gitを使った開発の基本ワークフロー
Gitを使った基本のワークフローを図に示します:

```{r git_fig, echo=FALSE, cache=FALSE}
mermaid("git_fig.mmd")
```

ポイントは**リポジトリ**という概念です。リポジトリの言葉の意味は…ググってください。パッケージやプロジェクトなどは、このリポジトリにまとめます。**プロジェクトなどの本体はリポジトリ**です。つまり、リポジトリを中心として、プロジェクト内のファイルを管理していくこととなります。

### リポジトリから作業コピー、そして編集とcommit
上の図ではリポジトリとして「ローカルリポジトリ」と「共有リポジトリ」とありますが、まずはローカルリポジトリだけを考えます。

まずはローカルリポジトリにあるファイルたちを手元にコピーします(**checkout**)。これによってできた手元のファイルたちを**作業コピー**といいます。これをああだこうだと編集して作っていきます。そう、**「コードを直接いじったりするのはコピーしたファイル」**です。ここが重要です。

本来リポジトリはプロジェクトやパッケージの本体です。それが気軽に編集していじれるとなると、正直不安ですし、リスクが高いでしょう。**本体はとても大切なもの**です。なのでコピーを作成して編集して、いけるかどうかを検証するのです。

手元の環境でテストを実施し、問題ないとなれば、その変更をローカルリポジトリへ反映(**commit**)します。これで本体であるリポジトリが更新されます。

もし、個人で開発していて特に公開も共有もしない、つまり「ただバージョン管理をしたいだけ」であれば、これでOKです。どんどんこのループを回しましょう。

### 共有リポジトリとローカルリポジトリ
Gitは共同開発を効率よく進ませるために開発されました。この共同開発でポイントになるのが**共有リポジトリとローカルリポジトリ**です。

**共有リポジトリ**(リモートリポジトリ)は、その名の通り共有のためのリポジトリで、他の人がアクセスできるような場所に置きます。先ほどまで説明したリポジトリはローカルにあるため、ローカル内だけです。共同開発をするためには共有リポジトリをメインとし、これを中心に開発していくこととなります。言い換えるなら、**共有リポジトリをみんなで開発していく**ということになります。つまり一番大事なのは共有リポジトリです。

基本的な流れは、先に示した図のとおりです。まず共有リポジトリにあるリポジトリを、ローカルのリポジトリへpullします。あとは前述した流れで編集してこのローカルリポジトリへcommitします。この段階では、まだ共有リポジトリは前のままです。

このローカルリポジトリの更新を、共有リポジトリへ反映させます。これをpushといいます。これが問題なく処理されれば、共有リポジトリが更新されることとなります。

以降、(1)共有リポジトリから最新の状態(head)をローカルリポジトリへpull、(2)ローカルリポジトリの内容を作業コピーへcheckout、(3)内容を編集、(4)編集した内容をローカルリポジトリへcommit、(5)ローカルリポジトリの更新を共有リポジトリへpush、を繰り返して開発していくこととなります。

### なんでこんな面倒なことになるの?
正直この手続はかなり面倒なものだと感じるはずです。ではなぜこのような手続きが必要なのでしょうか。

差分とバージョン管理だけなら、ローカルリポジトリまでの話で十分管理できます。差分やログが記録できますし、ブランチを切ったりすればより柔軟に進めることも可能です。ですがGitの一番のポイントは「共同開発」を念頭においていることです。共同開発をスムーズに進めていくために、ローカルリポジトリの上に共有リポジトリを設置する必要があるのです。次にその辺りを考えます。

### 共同開発と競合・merge
共同開発をするということは、複数の人が同一のリポジトリに対して編集して更新を行っていきます。したがってメンバー全員がこのリポジトリにアクセスできなければいけません。したがって、共有リポジトリを中心に回していくこととなります。

#### 競合が発生しないパターン
まずは、スムーズなパターンを見ていきます:

```{r conflict, echo=FALSE,cache=FALSE}
mermaid("git_repos_fig.mmd")
```

この場合、Aが作業して共有リポジトリがv1.01に更新されます。その後Bが作業するために、Aが更新したv1.01の共有リポジトリをBのローカルリポジトリへpullし、編集して共有リポジトリへpushします。これによって共有リポジトリはv1.02へと更新されることとなります。実にスムーズですね。

#### 競合が発生するパターン
では逆に、スムーズにいかないパターンを見てみます:

```{r conflict2, echo=FALSE,cache=FALSE}
mermaid("git_repos2_fig.mmd")
```

共同開発の場合、大抵は**同時に作業**します。つまり、上の図のような事態になることだって十分にありえるのです。この場合、Bがpushしてきた編集内容とv1.02+A2の編集内容と比較し、mergeして問題ないかをチェックします。

もしそのままmergeしても問題がない場合、すんなりとBの編集内容を採用していけばOkです。しかし、Bの編集をそのままmergeするとまずい(機能が動かなくなるなど)場合は、編集内容をチェックして、必要であれば書き換えや却下するなどして統合していきます。ここが割と面倒です。

なお、先ほど「競合がないパターン」で示した流れであっても問題が発生することもありますが、ソレについては省略します。

このような手続きを取ることにより、共有リポジトリを変更する際には必ず管理者がその更新をチェックできるようになります。つまり他の人との編集内容がバッティングしても慎重に対処することができるのです。またいつでも共有リポジトリはpullできるので、細心の状態へ追いつくことも容易ですし、深刻な不具合発生のためにロールバックするのも簡単です。

以上が、Gitによる共同開発の基本の流れ、および共同開発に関する基礎的な説明です。まずはこのイメージがすんなりと来るようにしてください。なおbranchやその他重要な用語・機能があるのですが、またの機会にします。

## GitHubについて
GitHubはGitとよく混合されたり誤解されたりしますが、GitHubは**共有リポジトリ置き場提供サービス**です。

共有リポジトリを利用するためには、メンバー全員がアクセスできるような対象(サーバなど)が必要です。それを自前で構築するとなると、専門スタッフや資金があればいいですがそうもいかないことが多いです。またオープンソースであるためには、世界中に向けてそのサーバへアクセスできるよう公開していくことになります。これらも人的・資金的コストなどかかります。

そこでGitHubです。GitHubはアカウントを作ることで**公開リポジトリを無制限に作成することができます**。なお世界中にオープンにするわけには行かない時は、**プライベートリポジトリ**も作成することが可能です。基本有償ですが、学生・教員であるならば登録・申請することで5リポジトリのプライベートリポジトリが持てます。これは非常に大きいので絶対に取得しましょう。

基本的な扱い(pushやpullなど)は同じです。またGitHubはWebインターフェースでブラウザ操作が可能です。この辺りはまたあとで説明します。